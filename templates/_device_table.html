{% set next_order = 'asc' if order == 'desc' else 'desc' %}

<style>
  /* Ticket notches */
  .ticket {
    position: relative;
    overflow: hidden;
  }
  .ticket::before,
  .ticket::after {
    content: "";
    position: absolute;
    top: 54px;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: rgb(249 250 251);
    border: 1px solid rgb(229 231 235);
    z-index: 5;
  }
  .ticket::before { left: -9px; }
  .ticket::after  { right: -9px; }

  /* HTMX indicator default hidden */
  .htmx-indicator { display: none; }
  .htmx-request .htmx-indicator { display: inline-flex; }
  .htmx-request.htmx-indicator { display: inline-flex; }
</style>

<!-- Sort + results header -->
<div class="flex flex-wrap items-center justify-between gap-2 mb-3">
  <div class="text-sm text-gray-600">
    {% if rows|length %}
      Showing <span class="font-semibold">{{ rows|length }}</span> device{{ '' if rows|length==1 else 's' }}
    {% else %}
      No devices found
    {% endif %}
  </div>

  <div class="flex items-center gap-2 text-sm">
    <span class="text-gray-500">Sort:</span>

    <a class="px-2 py-1 rounded border bg-white hover:bg-gray-50"
       hx-get="/ui/partials/device-table?q={{ q }}&sort_by=ip&order={{ 'desc' if sort_by!='ip' else next_order }}"
       hx-target="#device-table" hx-swap="innerHTML">
      IP {% if sort_by == 'ip' %}<span class="text-xs">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
    </a>

    <a class="px-2 py-1 rounded border bg-white hover:bg-gray-50"
       hx-get="/ui/partials/device-table?q={{ q }}&sort_by=sys_name&order={{ 'desc' if sort_by!='sys_name' else next_order }}"
       hx-target="#device-table" hx-swap="innerHTML">
      Name {% if sort_by == 'sys_name' %}<span class="text-xs">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
    </a>

    <a class="px-2 py-1 rounded border bg-white hover:bg-gray-50"
       hx-get="/ui/partials/device-table?q={{ q }}&sort_by=last_seen&order={{ 'desc' if sort_by!='last_seen' else next_order }}"
       hx-target="#device-table" hx-swap="innerHTML">
      Last seen {% if sort_by == 'last_seen' %}<span class="text-xs">{{ '▲' if order == 'asc' else '▼' }}</span>{% endif %}
    </a>
  </div>
</div>

{% if rows|length == 0 %}
  <div class="rounded-2xl border bg-white p-8 text-center text-sm text-gray-500">
    No devices found.
  </div>
{% else %}

<!-- Ticket cards grid -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
  {% for d in rows %}
  {% set did = d.ip|replace('.', '-') %}

  <div class="ticket rounded-2xl border bg-white shadow-sm hover:shadow-md transition">
    <!-- Top strip -->
    <div class="h-1.5 bg-gradient-to-r from-indigo-500 via-sky-500 to-emerald-500"></div>

    <!-- Header -->
    <div class="p-4 pb-3">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <a class="font-mono text-sm font-semibold text-indigo-700 hover:underline"
             href="/devices/{{ d.ip }}/ui">
            {{ d.ip }}
          </a>
          <div class="mt-1 text-sm font-medium text-gray-900 truncate">
            {{ d.sys_name or '—' }}
          </div>
        </div>

        {% if d.last_seen %}
          <span class="inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 px-2 py-0.5 text-xs font-medium">
            Seen
          </span>
        {% else %}
          <span class="inline-flex items-center rounded-full bg-slate-100 text-slate-700 px-2 py-0.5 text-xs font-medium">
            New
          </span>
        {% endif %}
      </div>

      <!-- Chips row -->
      <div class="mt-3 flex flex-wrap gap-1.5">
        {% if d.snmp_version %}
          <span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5 text-[11px] font-medium">
            SNMP {{ d.snmp_version }}
          </span>
        {% endif %}

        {% if d.vendor %}
          <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 px-2 py-0.5 text-[11px] font-medium">
            {{ d.vendor }}
          </span>
        {% endif %}

        {% if d.model %}
          <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 px-2 py-0.5 text-[11px] font-medium">
            {{ d.model }}
          </span>
        {% endif %}

        {% if not d.snmp_version and not d.vendor and not d.model %}
          <span class="inline-flex items-center rounded-full bg-gray-50 text-gray-500 px-2 py-0.5 text-[11px]">
            metadata —
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Perforation line -->
    <div class="px-4">
      <div class="border-t border-dashed border-gray-200"></div>
    </div>

    <!-- Body -->
    <div class="p-4 pt-3">
      <div class="text-xs text-gray-600 line-clamp-3 min-h-[3.75rem]">
        {{ d.sys_descr or '—' }}
      </div>

      <!-- Notes (lazy-loaded so it persists after refresh) -->
      <div class="mt-3"
           hx-get="/api/devices/{{ d.ip }}/note?as=html"
           hx-trigger="load"
           hx-target="this"
           hx-swap="outerHTML">
        <div class="text-[11px] text-gray-400">Loading note…</div>
      </div>

      <div class="mt-4 flex items-center justify-between gap-2">
        <div class="text-xs text-gray-500">
          Last seen:
          {% if d.last_seen %}
            <time class="font-mono" datetime="{{ d.last_seen }}">
              {% if d.last_seen.strftime is defined %}
                {{ d.last_seen.strftime("%Y-%m-%d %H:%M") }}
              {% else %}
                {{ d.last_seen }}
              {% endif %}
            </time>
          {% else %}
            —
          {% endif %}
        </div>

        <div class="flex items-center gap-2">
          <!-- Rescan (reuse existing /ui/scan) -->
          <form class="inline"
                hx-post="/ui/scan"
                hx-target="#rescan-status-{{ did }}"
                hx-swap="innerHTML"
                hx-indicator="#rescan-indicator-{{ did }}">
            <input type="hidden" name="mode" value="host">
            <input type="hidden" name="target" value="{{ d.ip }}">
            <input type="hidden" name="snmp_version" value="2c">
            <input type="hidden" name="community" value="public">
            <input type="hidden" name="port" value="161">
            <input type="hidden" name="timeout" value="2">
            <input type="hidden" name="retries" value="2">

            <button class="px-2 py-1 rounded bg-sky-600 text-white text-xs hover:bg-sky-700">
              Rescan
            </button>

            <span id="rescan-indicator-{{ did }}" class="htmx-indicator text-xs text-gray-500">
              Scanning…
            </span>
          </form>

          <a class="px-2 py-1 rounded bg-gray-900 text-white text-xs hover:bg-black"
             href="/devices/{{ d.ip }}/ui">
            Open
          </a>

          <button
            class="px-2 py-1 rounded bg-rose-600 text-white text-xs hover:bg-rose-700"
            hx-delete="/api/devices/{{ d.ip }}?q={{ q }}&sort_by={{ sort_by }}&order={{ order }}"
            hx-confirm="Delete device {{ d.sys_name or d.ip }}?"
            hx-target="#device-table"
            hx-swap="innerHTML">
            Delete
          </button>
        </div>
      </div>

      <div id="rescan-status-{{ did }}" class="mt-2 text-xs text-gray-500"></div>
    </div>
  </div>
  {% endfor %}
</div>

{% endif %}
